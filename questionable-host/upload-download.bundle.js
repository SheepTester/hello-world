const t=(new TextEncoder).encode("0123456789abcdef");function e(e){return(new TextDecoder).decode(function(e){const n=new Uint8Array(2*e.length);for(let s=0;s<n.length;s++){const o=e[s];n[2*s]=t[o>>4],n[2*s+1]=t[15&o]}return n}(e))}const n="md5: `data` is invalid type";class s{#t;#e;#n;#s;#o;#r;#i;#a;constructor(){this.#t=1732584193,this.#e=4023233417,this.#n=2562383102,this.#s=271733878,this.#o=new Uint8Array(64),this.#r=0,this.#i=0,this.#a=0}addLength(t){let e=this.#i;e+=t,e>4294967295&&(this.#a+=1),this.#i=e>>>0}hash(t){let e=this.#t,n=this.#e,s=this.#n,o=this.#s;const r=e=>t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24,i=(t,e)=>t<<e|t>>>32-e,a=r(0),h=r(4),c=r(8),l=r(12),f=r(16),w=r(20),d=r(24),g=r(28),u=r(32),y=r(36),b=r(40),p=r(44),S=r(48),m=r(52),A=r(56),U=r(60);e=n+i(((s^o)&n^o)+e+a+3614090360,7),o=e+i(((n^s)&e^s)+o+h+3905402710,12),s=o+i(((e^n)&o^n)+s+c+606105819,17),n=s+i(((o^e)&s^e)+n+l+3250441966,22),e=n+i(((s^o)&n^o)+e+f+4118548399,7),o=e+i(((n^s)&e^s)+o+w+1200080426,12),s=o+i(((e^n)&o^n)+s+d+2821735955,17),n=s+i(((o^e)&s^e)+n+g+4249261313,22),e=n+i(((s^o)&n^o)+e+u+1770035416,7),o=e+i(((n^s)&e^s)+o+y+2336552879,12),s=o+i(((e^n)&o^n)+s+b+4294925233,17),n=s+i(((o^e)&s^e)+n+p+2304563134,22),e=n+i(((s^o)&n^o)+e+S+1804603682,7),o=e+i(((n^s)&e^s)+o+m+4254626195,12),s=o+i(((e^n)&o^n)+s+A+2792965006,17),n=s+i(((o^e)&s^e)+n+U+1236535329,22),e=n+i(((n^s)&o^s)+e+h+4129170786,5),o=e+i(((e^n)&s^n)+o+d+3225465664,9),s=o+i(((o^e)&n^e)+s+p+643717713,14),n=s+i(((s^o)&e^o)+n+a+3921069994,20),e=n+i(((n^s)&o^s)+e+w+3593408605,5),o=e+i(((e^n)&s^n)+o+b+38016083,9),s=o+i(((o^e)&n^e)+s+U+3634488961,14),n=s+i(((s^o)&e^o)+n+f+3889429448,20),e=n+i(((n^s)&o^s)+e+y+568446438,5),o=e+i(((e^n)&s^n)+o+A+3275163606,9),s=o+i(((o^e)&n^e)+s+l+4107603335,14),n=s+i(((s^o)&e^o)+n+u+1163531501,20),e=n+i(((n^s)&o^s)+e+m+2850285829,5),o=e+i(((e^n)&s^n)+o+c+4243563512,9),s=o+i(((o^e)&n^e)+s+g+1735328473,14),n=s+i(((s^o)&e^o)+n+S+2368359562,20),e=n+i((n^s^o)+e+w+4294588738,4),o=e+i((e^n^s)+o+u+2272392833,11),s=o+i((o^e^n)+s+p+1839030562,16),n=s+i((s^o^e)+n+A+4259657740,23),e=n+i((n^s^o)+e+h+2763975236,4),o=e+i((e^n^s)+o+f+1272893353,11),s=o+i((o^e^n)+s+g+4139469664,16),n=s+i((s^o^e)+n+b+3200236656,23),e=n+i((n^s^o)+e+m+681279174,4),o=e+i((e^n^s)+o+a+3936430074,11),s=o+i((o^e^n)+s+l+3572445317,16),n=s+i((s^o^e)+n+d+76029189,23),e=n+i((n^s^o)+e+y+3654602809,4),o=e+i((e^n^s)+o+S+3873151461,11),s=o+i((o^e^n)+s+U+530742520,16),n=s+i((s^o^e)+n+c+3299628645,23),e=n+i((s^(n|~o))+e+a+4096336452,6),o=e+i((n^(e|~s))+o+g+1126891415,10),s=o+i((e^(o|~n))+s+A+2878612391,15),n=s+i((o^(s|~e))+n+w+4237533241,21),e=n+i((s^(n|~o))+e+S+1700485571,6),o=e+i((n^(e|~s))+o+l+2399980690,10),s=o+i((e^(o|~n))+s+b+4293915773,15),n=s+i((o^(s|~e))+n+h+2240044497,21),e=n+i((s^(n|~o))+e+u+1873313359,6),o=e+i((n^(e|~s))+o+U+4264355552,10),s=o+i((e^(o|~n))+s+d+2734768916,15),n=s+i((o^(s|~e))+n+m+1309151649,21),e=n+i((s^(n|~o))+e+f+4149444226,6),o=e+i((n^(e|~s))+o+p+3174756917,10),s=o+i((e^(o|~n))+s+c+718787259,15),n=s+i((o^(s|~e))+n+y+3951481745,21),this.#t=this.#t+e>>>0,this.#e=this.#e+n>>>0,this.#n=this.#n+s>>>0,this.#s=this.#s+o>>>0}update(t){let e;if("string"==typeof t)e=(new TextEncoder).encode(t);else{if("object"!=typeof t)throw new TypeError(n);if(!(t instanceof ArrayBuffer||ArrayBuffer.isView(t)))throw new TypeError(n);e=new Uint8Array(t)}let s=this.#r;const o=64-s;if(e.length<o)this.#o.set(e,s),s+=e.length;else{this.#o.set(e.slice(0,o),s),this.hash(this.#o);let t=o;for(;t+64<=e.length;)this.hash(e.slice(t,t+64)),t+=64;this.#o.fill(0).set(e.slice(t),0),s=e.length-t}return this.#r=s,this.addLength(e.length),this}digest(){let t=64-this.#r;t<9&&(t+=64);const e=new Uint8Array(t);e[0]=128;const n=this.#i<<3,s=this.#a<<3|this.#i>>>29;e[e.length-8]=255&n,e[e.length-7]=n>>>8&255,e[e.length-6]=n>>>16&255,e[e.length-5]=n>>>24&255,e[e.length-4]=255&s,e[e.length-3]=s>>>8&255,e[e.length-2]=s>>>16&255,e[e.length-1]=s>>>24&255,this.update(e.buffer);const o=new ArrayBuffer(16),r=new DataView(o);return r.setUint32(0,this.#t,!0),r.setUint32(4,this.#e,!0),r.setUint32(8,this.#n,!0),r.setUint32(12,this.#s,!0),o}toString(t="hex"){const n=this.digest();switch(t){case"hex":return e(new Uint8Array(n));case"base64":{const t=new Uint8Array(n);let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return btoa(e)}default:throw new Error("md5: invalid format")}}}const o=import.meta.main;class r extends Error{name=this.constructor.name;static async from(t){return new r(`HTTP error ${t.status} for ${t.url}. ${await t.text().catch((()=>"Could not get response text."))}`)}}const i=9999999,a=9999975,h="https://assets.scratch.mit.edu/";async function c(t,n,o="wav"){const i=(new s).update(t).digest(),a=e(new Uint8Array(i)),c=h+a+"."+o,l=await fetch(c,{method:"POST",credentials:"include",headers:n?{cookie:`scratchsessionsid=${n}`}:{},body:t});if(!l.ok)throw await r.from(l);return{hashBytes:i,hash:a,url:c}}async function l(t,n,s){if(t.size<=i){s?.(0);const{hash:e}=await c(await t.arrayBuffer(),n,"wav");return s?.(1),`${e}.`}const o=Math.ceil(t.size/a);let r=new ArrayBuffer(16);for(let e=o-1;e>=0;e--){s?.((o-1-e)/o);const i=e*a,h=new DataView(new ArrayBuffer(8));h.setBigUint64(0,BigInt(t.size-i));const l=new Blob([r,h,t.slice(i,i+a)]);r=(await c(await l.arrayBuffer(),n,"wav")).hashBytes}return s?.(1),e(new Uint8Array(r))}async function f(t,n,s){n?.(0);const o=[];let i,c=0,l=t;for(;l;){const t=await fetch(`${h}internalapi/asset/${l}.wav/get/`);if(!t.ok)throw await r.from(t);if(!t.body)throw new Error("No response body");const s=t.body.getReader(),f=new Uint8Array(24);let w=0;for(;;){const t=await s.read();if(t.done)break;let r=t.value;if(w<f.length){const t=f.length-w;if(f.set(r.slice(0,t),w),w+=r.length,w>=16&&(l=e(f.slice(0,16))),w>=f.length){const t=new DataView(f.buffer),e=Number(t.getBigUint64(16));i||(i=e),e<=a&&(l=null)}if(!(w>f.length))continue;r=r.slice(t)}o.push(r),c+=r.length,n&&i&&n(c/i,i)}}return new Blob(o,{type:s})}async function w(t,e,n){const s=[];let o=0;for(const n of t){e?.(o/t.length,t.length);const i=await fetch(`${h}internalapi/asset/${n}.wav/get/`);if(!i.ok)throw await r.from(i);if(!i.body)throw new Error("No response body");const a=i.headers.get("Content-Length");if(null===a)throw new Error("Content-Length header wasn't given");const c=+a,l=i.body.getReader();let f=0;for(;;){const n=await l.read();if(n.done)break;s.push(n.value),e&&(f+=n.value.length,e((o+f/c)/t.length,t.length))}o++}return e?.(1,t.length),new Blob(s,{type:n})}if(o){1!==Deno.args.length&&(console.log("Usage: SCRATCHSESSIONSID=<scratchsessionsid> deno run questionable-host/upload-download.ts <file>"),Deno.exit(1));const t=Deno.env.get("SCRATCHSESSIONSID");t||(console.log("The SCRATCHSESSIONSID environment variable should be set to your `scratchsessionsid` cookie."),Deno.exit(1));const e=await Deno.readFile(Deno.args[0]),{url:n}=await c(e.buffer,t,Deno.args[0].split(".").at(-1));console.log(n)}export{i as MAX_SIZE};export{c as uploadFile};export{l as upload};export{f as download};export{w as downloadOld};
